#!/bin/bash
# KLoROS System Consistency Check
# This script validates the installation and configuration of RZERO and Autopilot systems

set -e

echo "=== KLoROS System Consistency Check ==="
echo "Started at: $(date)"
echo

# Colors for output
RED="\033[0;31m"
GREEN="\033[0;32m"
YELLOW="\033[1;33m"
NC="\033[0m" # No Color

PASS=0
FAIL=0
WARN=0

check_pass() {
    echo -e "✅ ${GREEN}PASS${NC}: $1"
    ((PASS++))
}

check_fail() {
    echo -e "❌ ${RED}FAIL${NC}: $1"
    ((FAIL++))
}

check_warn() {
    echo -e "⚠️  ${YELLOW}WARN${NC}: $1"
    ((WARN++))
}

echo "## Core System Components"

# Check RZERO command
if command -v rzero >/dev/null 2>&1; then
    check_pass "RZERO command available at $(which rzero)"
else
    check_fail "RZERO command not found in PATH"
fi

# Check RZERO suite directory
if [[ -d "/opt/kloros/kloros_rzero_suite" ]]; then
    check_pass "RZERO suite directory exists"

    # Count jobs
    JOB_COUNT=$(find /opt/kloros/kloros_rzero_suite/rzero/jobs -name "*.yaml" | wc -l)
    if [[ $JOB_COUNT -ge 18 ]]; then
        check_pass "RZERO jobs present ($JOB_COUNT total)"
    else
        check_warn "Few RZERO jobs found ($JOB_COUNT, expected 18+)"
    fi
else
    check_fail "RZERO suite directory missing"
fi

echo
echo "## Autopilot Installation"

# Check autopilot directory
if [[ -d "/opt/kloros/kloros_autopilot" ]]; then
    check_pass "Autopilot directory exists"
else
    check_fail "Autopilot directory missing"
fi

# Check autopilot binaries
AUTOPILOT_BINS=("kloros-dnd" "kloros-activity-heartbeat" "kloros-forget")
for bin in "${AUTOPILOT_BINS[@]}"; do
    if [[ -x "$HOME/.local/bin/$bin" ]]; then
        check_pass "Autopilot binary: $bin"
    else
        check_fail "Missing or non-executable: $bin"
    fi
done

echo
echo "=== Summary ==="
echo -e "✅ Passed: ${GREEN}$PASS${NC}"
echo -e "⚠️  Warnings: ${YELLOW}$WARN${NC}"
echo -e "❌ Failed: ${RED}$FAIL${NC}"
echo

if [[ $FAIL -eq 0 ]]; then
    echo -e "${GREEN}✅ System check PASSED${NC}"
    exit 0
else
    echo -e "${RED}❌ System check FAILED${NC}"
    exit 1
fi
