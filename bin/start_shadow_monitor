#!/bin/bash
set -euo pipefail

MONITOR_SCRIPT="/home/kloros/bin/shadow_monitor_kloros"
LOG_FILE="/home/kloros/.kloros/logs/shadow_monitor.log"
PID_FILE="/home/kloros/.kloros/shadow_monitor.pid"

mkdir -p "$(dirname "$LOG_FILE")"
mkdir -p "$(dirname "$PID_FILE")"

if [ -f "$PID_FILE" ]; then
    OLD_PID=$(cat "$PID_FILE")
    if ps -p "$OLD_PID" > /dev/null 2>&1; then
        echo "Monitor already running (PID: $OLD_PID)"
        exit 0
    fi
    rm -f "$PID_FILE"
fi

echo "Starting shadow monitor with KLoROS voice alerts..."
echo "Log: $LOG_FILE"
echo "Monitor will speak alerts automatically - no wake word needed"
echo ""

nohup /home/kloros/.venv/bin/python3 -u "$MONITOR_SCRIPT" >> "$LOG_FILE" 2>&1 &
echo $! > "$PID_FILE"

echo "Monitor started (PID: $(cat "$PID_FILE"))"
echo "To stop: kill $(cat "$PID_FILE")"
echo "To view log: tail -f $LOG_FILE"
