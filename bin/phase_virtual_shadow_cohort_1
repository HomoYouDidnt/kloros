#!/home/kloros/.venv/bin/python3
"""
PHASE Virtual Shadow Validation - Cohort 1

Runs accelerated shadow validation simulating 7 virtual days of workload
coverage for maintenance_housekeeping and observability_logging niches.

This achieves workload equivalence without waiting 7 calendar days.
"""

import sys
import time
import logging
from pathlib import Path

sys.path.insert(0, str(Path.home() / 'src'))

from kloros.dream.phase_shadow_emulator import PHASEShadowEmulator

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)


def run_housekeeping_virtual_shadow():
    """Run virtual shadow validation for maintenance_housekeeping."""
    from housekeeping_scheduler import HousekeepingScheduler
    from zooids.wrappers.maintenance_housekeeping_v0_wrapper import HousekeepingZooid

    logger.info("=" * 80)
    logger.info("Virtual Shadow Validation: maintenance_housekeeping")
    logger.info("=" * 80)

    emulator = PHASEShadowEmulator()

    class MockKLoROS:
        def __init__(self):
            self.memory_system = None

    def legacy_factory():
        return HousekeepingScheduler(kloros_instance=MockKLoROS())

    def wrapper_factory():
        return HousekeepingZooid()

    start_time = time.time()

    result = emulator.run_virtual_shadow(
        niche="maintenance_housekeeping",
        legacy_factory=legacy_factory,
        wrapper_factory=wrapper_factory,
    )

    elapsed = time.time() - start_time

    logger.info(f"\n{'=' * 80}")
    logger.info(f"Virtual Shadow Complete: maintenance_housekeeping")
    logger.info(f"  Virtual Days: {result.virtual_days_completed}")
    logger.info(f"  Total Executions: {result.total_executions}")
    logger.info(f"  Behavioral Matches: {result.behavioral_match_count} ({result.behavioral_match_count / result.total_executions * 100:.2f}%)")
    logger.info(f"  Max Drift: {result.max_drift_percentage:.4f}%")
    logger.info(f"  Avg Drift: {result.avg_drift_percentage:.4f}%")
    logger.info(f"  Validation: {'✅ PASSED' if result.validation_passed else '❌ FAILED'}")
    logger.info(f"  Wall Time: {elapsed:.2f}s")
    logger.info(f"{'=' * 80}\n")

    return result


def run_logging_virtual_shadow():
    """Run virtual shadow validation for observability_logging."""
    from kloros.observability.ledger_writer_daemon import LedgerWriterDaemon
    from zooids.wrappers.observability_logging_v0_wrapper import LedgerWriterZooid

    logger.info("=" * 80)
    logger.info("Virtual Shadow Validation: observability_logging")
    logger.info("=" * 80)

    emulator = PHASEShadowEmulator()

    def legacy_factory():
        return LedgerWriterDaemon()

    def wrapper_factory():
        return LedgerWriterZooid()

    start_time = time.time()

    result = emulator.run_virtual_shadow(
        niche="observability_logging",
        legacy_factory=legacy_factory,
        wrapper_factory=wrapper_factory,
    )

    elapsed = time.time() - start_time

    logger.info(f"\n{'=' * 80}")
    logger.info(f"Virtual Shadow Complete: observability_logging")
    logger.info(f"  Virtual Days: {result.virtual_days_completed}")
    logger.info(f"  Total Executions: {result.total_executions}")
    logger.info(f"  Behavioral Matches: {result.behavioral_match_count} ({result.behavioral_match_count / result.total_executions * 100:.2f}%)")
    logger.info(f"  Max Drift: {result.max_drift_percentage:.4f}%")
    logger.info(f"  Avg Drift: {result.avg_drift_percentage:.4f}%")
    logger.info(f"  Validation: {'✅ PASSED' if result.validation_passed else '❌ FAILED'}")
    logger.info(f"  Wall Time: {elapsed:.2f}s")
    logger.info(f"{'=' * 80}\n")

    return result


def main():
    """Run virtual shadow validation for Cohort 1."""
    logger.info("Starting PHASE Virtual Shadow Validation - Cohort 1")
    logger.info(f"Timestamp: {time.strftime('%Y-%m-%d %H:%M:%S')}")
    logger.info("")

    overall_start = time.time()

    housekeeping_result = run_housekeeping_virtual_shadow()
    logging_result = run_logging_virtual_shadow()

    overall_elapsed = time.time() - overall_start

    logger.info("\n" + "=" * 80)
    logger.info("COHORT 1 VIRTUAL SHADOW VALIDATION SUMMARY")
    logger.info("=" * 80)

    logger.info(f"\nmaintenance_housekeeping:")
    logger.info(f"  Virtual Days: {housekeeping_result.virtual_days_completed}")
    logger.info(f"  Executions: {housekeeping_result.total_executions}")
    logger.info(f"  Match Rate: {housekeeping_result.behavioral_match_count / housekeeping_result.total_executions * 100:.2f}%")
    logger.info(f"  Avg Drift: {housekeeping_result.avg_drift_percentage:.4f}%")
    logger.info(f"  Status: {'✅ PASSED' if housekeeping_result.validation_passed else '❌ FAILED'}")

    logger.info(f"\nobservability_logging:")
    logger.info(f"  Virtual Days: {logging_result.virtual_days_completed}")
    logger.info(f"  Executions: {logging_result.total_executions}")
    logger.info(f"  Match Rate: {logging_result.behavioral_match_count / logging_result.total_executions * 100:.2f}%")
    logger.info(f"  Avg Drift: {logging_result.avg_drift_percentage:.4f}%")
    logger.info(f"  Status: {'✅ PASSED' if logging_result.validation_passed else '❌ FAILED'}")

    logger.info(f"\nTotal Wall Time: {overall_elapsed:.2f}s ({overall_elapsed / 60:.2f}m)")

    both_passed = housekeeping_result.validation_passed and logging_result.validation_passed

    logger.info(f"\n{'=' * 80}")
    if both_passed:
        logger.info("✅ COHORT 1 READY FOR SHORT REAL-WORLD SHADOW WINDOW")
        logger.info("   Virtual shadow validation complete - 7 virtual days simulated")
        logger.info("   Next: 24-hour real shadow deployment recommended")
    else:
        logger.info("❌ COHORT 1 FAILED VIRTUAL SHADOW VALIDATION")
        logger.info("   Address behavioral mismatches before proceeding")
    logger.info("=" * 80)

    return 0 if both_passed else 1


if __name__ == "__main__":
    sys.exit(main())
