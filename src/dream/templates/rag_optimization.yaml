# RAG Optimization: Evolve retrieval parameters and knowledge base indexing
family: rag.optimization

payload:
  type: optimize_rag_parameters
  target_domain: rag_context
  description: "Evolve RAG retrieval precision and latency through parameter tuning"

base:
  diff_limit: 50
  max_files_changed: 3
  preserve_api: true
  timeout_s: 300  # 5 min per candidate

# Parameter search space for RAG evolution
slots:
  # Top-k retrieval candidates
  top_k_values:
    - [3, 5, 7, 10]

  # Chunk size for document splitting
  chunk_sizes:
    - [256, 512, 1024, 2048]

  # Overlap between chunks
  chunk_overlaps:
    - [0, 50, 100, 200]

  # Similarity threshold for retrieval
  similarity_thresholds:
    - [0.5, 0.6, 0.7, 0.8]

  # Embedding model selection
  embedding_models:
    - ["sentence-transformers/all-MiniLM-L6-v2", "fast_small"]
    - ["sentence-transformers/all-mpnet-base-v2", "quality_medium"]

  # Reranking strategy
  reranking_enabled:
    - [true, false]

# Adaptive mutation based on test results
mutators:
  - type: increase_top_k
    trigger: low_recall
    action: increment_top_k
    factor: 1.5

  - type: decrease_top_k
    trigger: high_latency
    action: decrement_top_k
    factor: 0.8

  - type: increase_chunk_size
    trigger: low_precision
    action: increment_chunk_size
    factor: 1.5

  - type: decrease_chunk_size
    trigger: high_latency
    action: decrement_chunk_size
    factor: 0.7

  - type: enable_reranking
    trigger: low_precision
    action: set_reranking
    value: true

  - type: disable_reranking
    trigger: high_latency
    action: set_reranking
    value: false

# Fitness criteria from PHASE test results
expected:
  tests_pass: true
  retrieval_precision: ">0.6"  # 60% minimum precision
  total_latency_ms: "<3000"    # 3s maximum latency
  context_relevance: ">0.7"    # 70% relevance score
  answer_grounded: true        # Answers must be grounded in context

# Validation checks for evolved candidates
validation:
  - check: "RAG bundle loads without errors"
  - check: "Retrieval returns valid chunks"
  - check: "Precision meets threshold (>60%)"
  - check: "Latency within budget (<3000ms)"
  - check: "Answers are grounded in retrieved context"
  - check: "No hallucinations detected"

# Resource guardrails (D-REAM compliance)
resources:
  max_memory_mb: 2048
  max_cpu_percent: 70
  max_experiments_per_hour: 10
  max_bundle_size_mb: 100

# Knowledge base configuration
knowledge_base:
  source_path: "/home/kloros/knowledge_base"
  bundle_path: "/home/kloros/rag_data/rag_store.npz"
  metadata_path: "/home/kloros/rag_data/metadata.json"

  # Incremental reindexing (don't rebuild from scratch each time)
  incremental: true
  hash_verification: true

  # Document sources to index
  include_patterns:
    - "**/*.md"
    - "**/*.py"
    - "**/*.yaml"

  exclude_patterns:
    - "**/node_modules/**"
    - "**/__pycache__/**"
    - "**/venv/**"
    - "**/dist/**"

# Fitness function weights
fitness:
  # How much each metric contributes to overall fitness (sum to 1.0)
  weights:
    precision: 0.35      # Retrieval precision (most important)
    latency: 0.25        # Speed matters
    relevance: 0.20      # Context quality
    grounded_rate: 0.15  # Hallucination prevention
    recall: 0.05         # Coverage (less critical for RAG)

# Test queries for evaluation (same as PHASE domain tests)
test_queries:
  - query: "What is KLoROS?"
    expected_sources: ["system", "README"]
    expected_keywords: ["voice", "assistant", "AI"]

  - query: "How does D-REAM evolution work?"
    expected_sources: ["dream_evolution.md"]
    expected_keywords: ["genetic", "fitness", "mutation"]

  - query: "Explain the PHASE testing framework."
    expected_sources: ["PHASE"]
    expected_keywords: ["test", "hypothesis", "adaptive"]

  - query: "What are the TTS backends available?"
    expected_sources: ["tts", "configuration"]
    expected_keywords: ["piper", "xtts", "mimic"]

  - query: "How does the turn orchestrator work?"
    expected_sources: ["turn.py", "architecture"]
    expected_keywords: ["VAD", "STT", "TTS", "pipeline"]
