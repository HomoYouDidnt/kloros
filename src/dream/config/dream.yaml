version: 1
run:
  seed: 20251021
  artifact_root: /home/kloros/artifacts/dream
  # Global safety budgets
  global_budget:
    wallclock_sec: 600        # per runlet
    max_candidates: 24
    max_generations: 6
    cpu_percent_cap: 75
    allow_gpu: true
  scheduling:
    selection: round_robin    # rotate experiments
    max_parallel: 2
    backoff_on_failure_sec: 60

# SPICA instance retention to prevent disk exhaustion
spica_retention:
  max_instances: 10           # Keep at most N instances
  max_age_days: 3             # Delete instances older than N days
  prune_on_spawn: true        # Auto-prune before creating new instances
  min_free_space_gb: 20       # Abort if free space drops below threshold

mutators:
  - name: gaussian_nudge
    kind: numeric
    sigma: 0.15
  - name: categorical_swap
    kind: categorical
    p: 0.25

fitness_aggregation:
  method: weighted_sum
  weights:
    throughput: 0.35
    latency: 0.35
    quality: 0.30

# ===== EXPERIMENTS (FULL SPICA COVERAGE) =====
experiments:

  # ========================================
  # RAG Optimization (MIGRATED TO SPICA)
  # ========================================
  - name: rag_opt_spica
    enabled: true
    template: null
    search_space:
      top_k: [3, 5, 7, 10]
      chunk_size: [256, 512, 768, 1024]
      similarity_threshold: [0.55, 0.65, 0.75, 0.85]
      rerank: [true, false]
    evaluator:
      path: /home/kloros/src/phase/domains/spica_rag.py
      class: SpicaRAG
      init_kwargs: {}
    budget:
      wallclock_sec: 420
      max_candidates: 12
      max_generations: 4
      allow_gpu: false
    metrics:
      target_direction:
        context_recall: "up"
        context_precision: "up"
        response_latency_ms: "down"
      map:
        context_precision: quality
        response_latency_ms: latency
        context_recall: throughput
    selector:
      kind: rzero
      tournament_size: 4
      survivors: 2
      elitism: 1
      fresh_inject: 1

  # ========================================
  # Audio Latency (KEEP LEGACY)
  # ========================================
  - name: audio_latency_trim
    enabled: false  # No SPICA version yet
    template: /home/kloros/src/dream/templates/performance_caching.yaml
    search_space:
      sample_rates: [16000, 22050, 24000]
      frame_sizes: [256, 320, 512]
      buffering_strategy: ["double", "triple"]
      resampler: ["soxr", "speex"]
    evaluator:
      path: /home/kloros/src/dream/domains/audio_domain_evaluator.py
      class: AudioDomainEvaluator
      init_kwargs: {}
    budget:
      wallclock_sec: 360
      max_candidates: 12
      max_generations: 4
      allow_gpu: false
    metrics:
      target_direction:
        end_to_end_latency_ms_p95: "down"
        underrun_count: "down"
        cpu_percent: "down"
      map:
        end_to_end_latency_ms_p95: latency
        underrun_count: quality
        cpu_percent: throughput
    overrides:
      fitness_weights:
        throughput: -0.25
        latency: 0.5
        quality: 0.75

  # ========================================
  # Conversation Quality (MIGRATED TO SPICA)
  # ========================================
  - name: conv_quality_spica
    enabled: true
    template: null
    search_space:
      max_context_turns: [6, 8, 10, 12]
      response_style: ["concise", "detailed", "adaptive"]
      temperature: [0.3, 0.5, 0.7, 0.9]
      context_window: [2048, 4096, 8192]
    evaluator:
      path: /home/kloros/src/phase/domains/spica_conversation.py
      class: SpicaConversation
      init_kwargs: {}
    budget:
      wallclock_sec: 480
      max_candidates: 12
      max_generations: 4
      allow_gpu: false
    metrics:
      target_direction:
        coherence: "up"
        relevance: "up"
        latency_ms: "down"
      map:
        coherence: quality
        relevance: quality
        latency_ms: latency
    selector:
      kind: rzero
      tournament_size: 4
      survivors: 2
      elitism: 1
      fresh_inject: 1

  # ========================================
  # Tool Evolution (KEEP LEGACY)
  # ========================================
  - name: tool_evolution
    enabled: false  # Keep original
    search_space:
      tool_idx: [0, 1, 2]
      mode_fast: [0, 1]
      mode_accurate: [0, 1]
      verbose: [0, 1]
      threshold: [0.001, 0.003, 0.005, 0.01, 0.015, 0.02, 0.03, 0.05, 0.075, 0.1, 0.15]
      window_ms: [5, 10, 15, 20, 25, 30, 40, 50, 60, 75, 100, 125, 150, 200]
    evaluator:
      path: /home/kloros/src/dream/domains/audio_cli_tool_evaluator.py
      class: AudioCLIToolEvaluator
      init_kwargs: {}
    budget:
      wallclock_sec: 240
      max_candidates: 16
      max_generations: 6
      allow_gpu: false
    metrics:
      target_direction:
        fail_rate: "down"
        latency_ms_p95: "down"
        f1_score: "up"
        qps: "up"
      map:
        fail_rate: quality
        latency_ms_p95: latency
        f1_score: quality
        qps: throughput
    overrides:
      fitness_weights:
        quality: 0.5
        latency: 0.3
        throughput: 0.2
    selector:
      kind: rzero
      tournament_size: 4
      survivors: 2
      elitism: 1
      fresh_inject: 1
    convergence:
      patience_gens: 2

  # ========================================
  # SPICA Cognitive Variants (KEEP)
  # ========================================
  - name: spica_cognitive_variants
    enabled: false
    template: null
    search_space:
      tau_persona: [0.01, 0.02, 0.03, 0.05]
      tau_task: [0.06, 0.08, 0.10, 0.12]
      max_context_turns: [6, 8, 10]
    evaluator:
      path: /home/kloros/src/dream/evaluators/spica_tournament_evaluator.py
      class: SPICATournamentEvaluator
      init_kwargs:
        suite_id: "qa.rag.gold"
        qtime:
          epochs: 2
          slices_per_epoch: 4
          replicas_per_slice: 8
    budget:
      wallclock_sec: 600
      max_candidates: 8
      max_generations: 4
      allow_gpu: false
    metrics:
      target_direction:
        exact_match_mean: "up"
        latency_p50_ms: "down"
      map:
        exact_match_mean: quality
        latency_p50_ms: latency
    selector:
      kind: rzero
      tournament_size: 4
      survivors: 1
      elitism: 0
      fresh_inject: 0
    convergence:
      patience_gens: 2

  # ========================================
  # RepairLab Code Repair (KEEP)
  # ========================================
  - name: spica_repairlab
    enabled: true
    template: null
    search_space:
      difficulty: ["easy", "medium", "hard"]
      seed: [1337, 2025, 31415, 42000, 99999]
    evaluator:
      path: /home/kloros/src/phase/domains/spica_repairlab.py
      class: RepairLabEvaluator
      init_kwargs:
        weights:
          compile_success: 0.20
          test_pass_rate: 0.40
          edit_distance: 0.15
          runtime_parity: 0.15
          patch_readability: 0.10
    budget:
      wallclock_sec: 480
      max_candidates: 12
      max_generations: 4
      allow_gpu: false
    metrics:
      target_direction:
        compile_success: "up"
        test_pass_rate: "up"
        edit_distance: "up"
        runtime_parity: "up"
        patch_readability: "up"
      map:
        compile_success: quality
        test_pass_rate: quality
        edit_distance: quality
        runtime_parity: throughput
        patch_readability: quality
    selector:
      kind: rzero
      tournament_size: 4
      survivors: 2
      elitism: 1
      fresh_inject: 2
    convergence:
      patience_gens: 3

  # ========================================
  # TTS Optimization (NEW)
  # ========================================
  - name: spica_tts
    enabled: true
    template: null
    search_space:
      voice_model: ["piper-en-us-amy", "piper-en-us-ryan", "piper-en-gb-alan"]
      sample_rate: [16000, 22050, 24000]
      speed: [0.9, 1.0, 1.1, 1.2]
      noise_scale: [0.333, 0.5, 0.667, 0.8]
      length_scale: [0.9, 1.0, 1.1]
    evaluator:
      path: /home/kloros/src/phase/domains/spica_tts.py
      class: SpicaTTS
      init_kwargs: {}
    budget:
      wallclock_sec: 360
      max_candidates: 12
      max_generations: 4
      allow_gpu: false
    metrics:
      target_direction:
        audio_quality: "up"
        latency_ms: "down"
        wer: "down"
      map:
        audio_quality: quality
        latency_ms: latency
        wer: quality
    selector:
      kind: rzero
      tournament_size: 4
      survivors: 2
      elitism: 1
      fresh_inject: 1

  # ========================================
  # Turn Management (NEW)
  # ========================================
  - name: spica_turns
    enabled: true
    template: null
    search_space:
      vad_threshold: [0.3, 0.4, 0.5, 0.6]
      min_speech_ms: [100, 200, 300]
      max_silence_ms: [500, 750, 1000, 1500]
      interrupt_policy: ["always", "polite", "never"]
    evaluator:
      path: /home/kloros/src/phase/domains/spica_turns.py
      class: SpicaTurns
      init_kwargs: {}
    budget:
      wallclock_sec: 300
      max_candidates: 10
      max_generations: 4
      allow_gpu: false
    metrics:
      target_direction:
        turn_accuracy: "up"
        false_triggers: "down"
        latency_ms: "down"
      map:
        turn_accuracy: quality
        false_triggers: quality
        latency_ms: latency
    selector:
      kind: rzero
      tournament_size: 4
      survivors: 2
      elitism: 1
      fresh_inject: 1

  # ========================================
  # MCP Protocol (NEW)
  # ========================================
  - name: spica_mcp
    enabled: false  # Enable when MCP integration is ready
    template: null
    search_space:
      transport: ["stdio", "sse"]
      timeout_ms: [5000, 10000, 15000]
      max_retries: [2, 3, 5]
      batch_size: [1, 5, 10]
    evaluator:
      path: /home/kloros/src/phase/domains/spica_mcp.py
      class: SpicaMCP
      init_kwargs: {}
    budget:
      wallclock_sec: 300
      max_candidates: 8
      max_generations: 3
      allow_gpu: false
    metrics:
      target_direction:
        success_rate: "up"
        latency_ms: "down"
        throughput: "up"
      map:
        success_rate: quality
        latency_ms: latency
        throughput: throughput
    selector:
      kind: rzero
      tournament_size: 4
      survivors: 2
      elitism: 1
      fresh_inject: 1

  # ========================================
  # Planning Strategies (NEW)
  # ========================================
  - name: spica_planning
    enabled: true
    template: null
    search_space:
      strategy: ["greedy", "beam", "mcts", "adaptive"]
      lookahead_depth: [1, 2, 3, 4]
      pruning_threshold: [0.1, 0.3, 0.5]
      max_plan_steps: [5, 10, 15, 20]
    evaluator:
      path: /home/kloros/src/phase/domains/spica_planning.py
      class: SpicaPlanning
      init_kwargs: {}
    budget:
      wallclock_sec: 480
      max_candidates: 10
      max_generations: 4
      allow_gpu: false
    metrics:
      target_direction:
        plan_quality: "up"
        plan_latency_ms: "down"
        success_rate: "up"
      map:
        plan_quality: quality
        plan_latency_ms: latency
        success_rate: quality
    selector:
      kind: rzero
      tournament_size: 4
      survivors: 2
      elitism: 1
      fresh_inject: 1

  # ========================================
  # System Health Monitoring (NEW)
  # ========================================
  - name: spica_system_health
    enabled: true
    template: null
    search_space:
      check_interval_ms: [1000, 5000, 10000]
      alert_threshold: [0.7, 0.8, 0.9]
      metrics: [["cpu", "memory"], ["cpu", "memory", "disk"], ["all"]]
      history_window: [60, 300, 900]
    evaluator:
      path: /home/kloros/src/phase/domains/spica_system_health.py
      class: SpicaSystemHealth
      init_kwargs: {}
    budget:
      wallclock_sec: 240
      max_candidates: 8
      max_generations: 3
      allow_gpu: false
    metrics:
      target_direction:
        detection_accuracy: "up"
        false_alarm_rate: "down"
        overhead_cpu_pct: "down"
      map:
        detection_accuracy: quality
        false_alarm_rate: quality
        overhead_cpu_pct: latency
    selector:
      kind: rzero
      tournament_size: 4
      survivors: 2
      elitism: 1
      fresh_inject: 1

  # ========================================
  # ToolGen: Autonomous Tool Synthesis (NEW)
  # ========================================
  - name: spica_toolgen
    enabled: true  # ðŸš€ TOURNAMENT ACTIVATED!
    template: null
    search_space:
      spec_id: ["text_deduplicate"]
    evaluator:
      path: /home/kloros/src/phase/domains/spica_toolgen.py
      class: ToolGenEvaluator
      init_kwargs: {}
    budget:
      wallclock_sec: 300
      max_candidates: 8
      max_generations: 3
      allow_gpu: false
    metrics:
      target_direction:
        correctness: "up"
        safety: "up"
        performance: "up"
        robustness: "up"
        documentation: "up"
      map:
        correctness: quality
        safety: quality
        performance: throughput
        robustness: quality
        documentation: quality
    selector:
      kind: rzero
      tournament_size: 4
      survivors: 2
      elitism: 1
      fresh_inject: 1

  # ========================================
  # GPU Resource Allocation (NEW - Autonomous Optimization)
  # ========================================
  - name: spica_gpu_allocation
    enabled: false  # DISABLED: Search space invalid for 12GB GPU, stuck in infinite loop with 4K+ wasted evaluations
    template: null
    search_space:
      vllm_memory_util: [0.40, 0.45, 0.50, 0.55, 0.60]
      whisper_model_size: ["tiny", "base", "small"]
    evaluator:
      path: /home/kloros/src/phase/domains/spica_gpu_allocation.py
      class: SpicaGPUAllocation
      init_kwargs: {}
    budget:
      wallclock_sec: 360
      max_candidates: 10
      max_generations: 4
      allow_gpu: true  # This experiment requires GPU access
    metrics:
      target_direction:
        stt_latency_ms: "down"
        llm_latency_ms: "down"
        gpu_utilization: "neutral"  # Target ~70%, not min/max
        oom_events: "down"  # Must be zero
        concurrent_capacity: "up"
      map:
        stt_latency_ms: latency
        llm_latency_ms: latency
        concurrent_capacity: throughput
        gpu_utilization: quality
        oom_events: quality
    selector:
      kind: rzero
      tournament_size: 4
      survivors: 2
      elitism: 1
      fresh_inject: 1

logging:
  level: INFO
  jsonl_per_epoch: true
  files:
    summary: metrics.jsonl
    per_candidate: candidates.jsonl
  upload: null
