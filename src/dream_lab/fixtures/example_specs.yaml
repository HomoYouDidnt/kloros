# D-REAM Chaos Lab - Example Failure Scenarios
#
# Each scenario tests a specific failure mode and validates self-healing response

scenarios:
  # Scenario 1: Tool synthesis timeout (known issue)
  - id: synth_timeout_easy
    target: "rag.synthesis"
    mode: "timeout"
    params:
      delay_s: 35
    guards:
      max_duration_s: 20
    expected:
      heal_event:
        source: "rag"
        kind: "synthesis_timeout"

  # Scenario 2: Aggressive synthesis timeout
  - id: synth_timeout_hard
    target: "rag.synthesis"
    mode: "timeout"
    params:
      delay_s: 60
    guards:
      max_duration_s: 30
    expected:
      heal_event:
        source: "rag"
        kind: "synthesis_timeout"

  # Scenario 3: Audio beep echo loop (known issue)
  - id: beep_echo
    target: "audio.beep"
    mode: "jitter"
    params:
      base_ms: 200
      jitter_ms: 300
    guards:
      max_duration_s: 15
    expected:
      heal_event:
        source: "audio"
        kind: "beep_echo"

  # Scenario 4: Validator low context rejection (known issue)
  - id: validator_low_context
    target: "validator"
    mode: "threshold"
    params:
      threshold: 0.15
    guards:
      max_duration_s: 10
    expected:
      heal_event:
        source: "validator"
        kind: "low_context_overlap"

  # Scenario 5: Validator very strict (stress test)
  - id: validator_ultra_strict
    target: "validator"
    mode: "threshold"
    params:
      threshold: 0.25
    guards:
      max_duration_s: 12
    expected:
      heal_event:
        source: "validator"
        kind: "low_context_overlap"

  # Scenario 6: GPU out of memory during D-REAM evolution
  - id: gpu_oom_dream
    target: "dream.domain:cpu"
    mode: "oom"
    params:
      device: "gpu"
      bytes_req: 268435456  # 256MB cap
    guards:
      max_duration_s: 25
    expected: {}

  # Scenario 7: CPU memory pressure
  - id: cpu_oom
    target: "dream.domain:cpu"
    mode: "oom"
    params:
      device: "cpu"
      bytes_req: 536870912  # 512MB cap
    guards:
      max_duration_s: 20
    expected: {}

  # Scenario 8: Corrupted D-REAM candidate file
  - id: corrupt_dream_candidate
    target: "dream.candidate"
    mode: "corrupt"
    params:
      path: "/home/kloros/.kloros/dream_candidates/latest.json"
      bytes_to_flip: 128
    guards:
      max_duration_s: 15
    expected: {}

  # Scenario 9: Tool synthesis quota exceeded
  - id: quota_exceeded_synth
    target: "rag.synthesis"
    mode: "quota"
    params:
      service: "tool_synth"
    guards:
      max_duration_s: 10
    expected:
      heal_event:
        source: "rag"
        kind: "quota_exceeded"

  # Scenario 10: TTS latency spike
  - id: tts_latency_spike
    target: "tts"
    mode: "jitter"
    params:
      base_ms: 500
      jitter_ms: 800
    guards:
      max_duration_s: 15
    expected: {}

  # Scenario 11: TTS timeout
  - id: tts_timeout
    target: "tts"
    mode: "timeout"
    params:
      delay_s: 3
    guards:
      max_duration_s: 10
    expected: {}

  # Scenario 12: Intermittent synthesis failures
  - id: synth_intermittent
    target: "rag.synthesis"
    mode: "intermittent"
    params:
      fail_rate: 0.5
    guards:
      max_duration_s: 20
    expected:
      heal_event:
        source: "rag"
        kind: "synthesis_timeout"

  # Scenario 13: Composite - validator + synthesis timeout
  - id: composite_validator_timeout
    target: "validator+rag.synthesis"
    mode: "composite"
    params:
      fault_a:
        target: "validator"
        mode: "threshold"
        params:
          threshold: 0.18
      fault_b:
        target: "rag.synthesis"
        mode: "timeout"
        params:
          delay_s: 40
    guards:
      max_duration_s: 25
    expected:
      heal_events:
        - source: "validator"
          kind: "low_context_overlap"
        - source: "rag"
          kind: "synthesis_timeout"
