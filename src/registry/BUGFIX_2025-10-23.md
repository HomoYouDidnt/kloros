# Bug Fix: Environment Variable Parsing with Inline Comments

**Date**: 2025-10-23
**Status**: ✅ FIXED
**Severity**: HIGH (blocked autonomous curiosity system)

## Problem

The autonomous curiosity system (reasoning.curiosity and reasoning.autonomy capabilities) were incorrectly reported as MISSING despite environment variables being set correctly.

### Root Cause

Environment variables in `.kloros_env` contain inline comments:
```bash
KLR_ENABLE_CURIOSITY=1  # Enable proactive exploration
KLR_AUTONOMY_LEVEL=2  # Proactive analysis and improvement proposals
```

When loaded into the environment, these become:
```python
os.getenv("KLR_ENABLE_CURIOSITY")  # Returns "1  # Enable proactive exploration"
```

The capability evaluator was comparing:
- Expected: `"1"`
- Actual: `"1  # Enable proactive exploration"`
- Result: **FAIL** ❌

### Additional Bug

Numeric comparisons like `KLR_AUTONOMY_LEVEL>=2` were also broken because the parser split on `=` before checking for `>=`, causing:
```python
var = "KLR_AUTONOMY_LEVEL>"  # Wrong! Includes the >
expected = "2"
```

## Solution

**File**: `/home/kloros/src/registry/capability_evaluator.py`

### Fix 1: Strip Inline Comments (Lines 237-243, 258-261, 404-407)

Before comparing environment variable values, strip inline comments:
```python
if "#" in actual:
    actual = actual.split("#", 1)[0].strip()
else:
    actual = actual.strip()
```

### Fix 2: Parse Comparison Operators First (Lines 235-252)

Check for `>=` BEFORE splitting on `=`:
```python
if ">=" in env_spec:
    var, threshold_str = env_spec.split(">=", 1)
    actual = os.getenv(var, "")
    # Strip comments...
    actual_num = int(actual) if actual else 0
    threshold = int(threshold_str)
    if actual_num >= threshold:
        return (True, f"{var}={actual_num} >= {threshold}")
```

## Verification

```bash
KLR_ENABLE_CURIOSITY="1  # Enable proactive exploration" \
KLR_AUTONOMY_LEVEL="2  # Proactive analysis" \
python3 -c "
from registry.capability_evaluator import CapabilityEvaluator
evaluator = CapabilityEvaluator()
result1, msg1 = evaluator.check_precondition('env:KLR_ENABLE_CURIOSITY=1')
result2, msg2 = evaluator.check_precondition('env:KLR_AUTONOMY_LEVEL>=2')
print(f'✓ {msg1}')
print(f'✓ {msg2}')
"
```

**Result**: ✅ Both checks pass

## Impact

Once KLoROS process restarts, the following capabilities will become operational:

1. **reasoning.curiosity** → Enables:
   - generate_questions
   - propose_experiments
   - self_directed_learning

2. **reasoning.autonomy** → Enables:
   - propose_improvement
   - safe_action
   - self_heal

3. **Affordances unlocked**:
   - ask_questions (curiosity + introspection)
   - propose_improvement (autonomy + curiosity)
   - self_heal (autonomy + introspection)

## Next Steps

The fix is complete. Changes will take effect when:
1. KLoROS voice process restarts (automatic on next system boot)
2. Manual restart: `systemctl restart kloros-voice.service` (if systemd managed)
3. Next idle reflection cycle will use old code until process restart

## Files Modified

- `/home/kloros/src/registry/capability_evaluator.py` (lines 231-270, 398-410)

## Evidence

**Before**:
```json
{
  "key": "reasoning.curiosity",
  "state": "missing",
  "why": "Precondition failed: KLR_ENABLE_CURIOSITY= (expected 1)"
}
```

**After** (when process restarts):
```json
{
  "key": "reasoning.curiosity",
  "state": "ok",
  "why": "All preconditions met"
}
```

---

**Built by**: Claude (Sonnet 4.5)
**Autonomous Detection**: Yes (curiosity system self-identified the gap!)
