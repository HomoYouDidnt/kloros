<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>KLoROS Observations - D-REAM Dashboard</title>
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  <script src="https://unpkg.com/htmx.org@1.9.12/dist/ext/sse.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    [x-cloak] { display: none !important; }
    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .observation-card.new {
      animation: fadeIn 0.5s ease-out;
    }
  </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  <!-- Toast notification -->
  <div id="toast" class="fixed top-4 right-4 bg-slate-800 text-white px-4 py-3 rounded-lg shadow-lg hidden z-50">
    <div id="toast-message"></div>
  </div>

  <div class="max-w-7xl mx-auto p-6 space-y-6" x-data="observationsApp()" x-init="init()">
    <!-- Header -->
    <header class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <a href="/" class="text-slate-400 hover:text-white transition">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
        </a>
        <h1 class="text-3xl font-bold">KLoROS Observations</h1>
      </div>
      <div class="text-sm opacity-80">Autonomous Insights & Reflection</div>
    </header>

    <!-- Stats Cards -->
    <section class="grid md:grid-cols-4 gap-4">
      <div class="rounded-2xl bg-slate-900 p-4 shadow">
        <div class="text-slate-400 text-sm">Total Observations</div>
        <div class="text-3xl font-semibold" x-text="observations.stats?.total_count || 0"></div>
      </div>
      <div class="rounded-2xl bg-slate-900 p-4 shadow">
        <div class="text-slate-400 text-sm">Avg Confidence</div>
        <div class="text-3xl font-semibold" x-text="observations.stats?.avg_confidence || 0"></div>
      </div>
      <div class="rounded-2xl bg-slate-900 p-4 shadow">
        <div class="text-slate-400 text-sm">Latest Update</div>
        <div class="text-lg font-semibold" x-text="formatLatestTime()"></div>
      </div>
      <div class="rounded-2xl bg-slate-900 p-4 shadow">
        <div class="text-slate-400 text-sm">Top Keywords</div>
        <div class="text-sm flex flex-wrap gap-1 mt-1">
          <template x-for="keyword in observations.stats?.top_keywords?.slice(0, 3) || []" :key="keyword">
            <span class="px-2 py-0.5 bg-slate-700 text-slate-300 rounded text-xs" x-text="keyword"></span>
          </template>
        </div>
      </div>
    </section>

    <!-- Phase Tabs -->
    <section class="rounded-2xl bg-slate-900 shadow">
      <div class="flex items-center gap-2 p-4 border-b border-slate-800 overflow-x-auto">
        <button @click="activePhase = 'all'"
                :class="activePhase === 'all' ? 'bg-indigo-600' : 'bg-slate-800 hover:bg-slate-700'"
                class="px-4 py-2 rounded-lg font-medium transition whitespace-nowrap">
          All Phases
        </button>
        <button @click="activePhase = 1"
                :class="activePhase === 1 ? 'bg-blue-600' : 'bg-slate-800 hover:bg-slate-700'"
                class="px-4 py-2 rounded-lg font-medium transition whitespace-nowrap">
          Phase 1: Semantic
        </button>
        <button @click="activePhase = 2"
                :class="activePhase === 2 ? 'bg-purple-600' : 'bg-slate-800 hover:bg-slate-700'"
                class="px-4 py-2 rounded-lg font-medium transition whitespace-nowrap">
          Phase 2: Meta-Cognitive
        </button>
        <button @click="activePhase = 3"
                :class="activePhase === 3 ? 'bg-green-600' : 'bg-slate-800 hover:bg-slate-700'"
                class="px-4 py-2 rounded-lg font-medium transition whitespace-nowrap">
          Phase 3: Synthesis
        </button>
        <button @click="activePhase = 4"
                :class="activePhase === 4 ? 'bg-orange-600' : 'bg-slate-800 hover:bg-slate-700'"
                class="px-4 py-2 rounded-lg font-medium transition whitespace-nowrap">
          Phase 4: Optimization
        </button>
      </div>

      <!-- Phase Description -->
      <div class="p-4 bg-slate-800/50 text-sm text-slate-300">
        <template x-if="activePhase === 'all'">
          <p>Showing all observations across all analysis phases</p>
        </template>
        <template x-if="activePhase === 1">
          <p><strong>Phase 1: Semantic Analysis</strong> - Understanding conversation topics, themes, and user intent patterns</p>
        </template>
        <template x-if="activePhase === 2">
          <p><strong>Phase 2: Meta-Cognitive</strong> - Self-assessment of capabilities, learning progress, and improvement opportunities</p>
        </template>
        <template x-if="activePhase === 3">
          <p><strong>Phase 3: Cross-Cycle Synthesis</strong> - Pattern recognition and relationship evolution over time</p>
        </template>
        <template x-if="activePhase === 4">
          <p><strong>Phase 4: Adaptive Optimization</strong> - Performance tuning, parameter adjustments, and predictive insights</p>
        </template>
      </div>

      <!-- Observations Grid -->
      <div x-show="!loading" x-cloak class="p-6">
        <template x-if="getFilteredObservations().length === 0">
          <div class="text-center py-12 text-slate-400">
            <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
            </svg>
            <p class="text-lg">No observations found for this phase</p>
          </div>
        </template>

        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
          <template x-for="obs in getFilteredObservations()" :key="obs.id">
            <div class="observation-card bg-slate-800 rounded-lg p-4 shadow-lg border border-slate-700 hover:border-slate-500 transition">
              <!-- Phase Badge -->
              <span class="inline-block px-2 py-1 text-xs font-semibold rounded"
                    :class="{
                      'bg-blue-600 text-white': obs.phase === 1,
                      'bg-purple-600 text-white': obs.phase === 2,
                      'bg-green-600 text-white': obs.phase === 3,
                      'bg-orange-600 text-white': obs.phase === 4
                    }"
                    x-text="obs.phase_name"></span>

              <!-- Title -->
              <h3 class="text-lg font-bold text-white mt-2 mb-2" x-text="obs.title"></h3>

              <!-- Content (expandable) -->
              <div x-data="{ expanded: false }">
                <p class="text-gray-300 text-sm"
                   :class="expanded ? '' : 'line-clamp-3'"
                   x-text="obs.content"></p>
                <button @click="expanded = !expanded"
                        x-show="obs.content.length > 150"
                        class="text-xs text-indigo-400 hover:text-indigo-300 mt-1">
                  <span x-text="expanded ? 'Show less' : 'Read more'"></span>
                </button>
              </div>

              <!-- Metadata Row -->
              <div class="flex items-center justify-between mt-3 pt-3 border-t border-slate-700">
                <!-- Confidence -->
                <div class="flex items-center gap-2">
                  <span class="text-xs text-gray-400">Confidence:</span>
                  <span class="text-sm font-semibold"
                        :class="{
                          'text-green-400': obs.confidence >= 0.8,
                          'text-yellow-400': obs.confidence >= 0.6 && obs.confidence < 0.8,
                          'text-red-400': obs.confidence < 0.6
                        }"
                        x-text="obs.confidence.toFixed(2)"></span>
                </div>

                <!-- Timestamp -->
                <span class="text-xs text-gray-500" x-text="obs.relative_time"></span>
              </div>

              <!-- Keywords -->
              <template x-if="obs.keywords && obs.keywords.length > 0">
                <div class="flex gap-1 mt-2 flex-wrap">
                  <template x-for="keyword in obs.keywords.slice(0, 5)" :key="keyword">
                    <span class="px-2 py-0.5 text-xs bg-slate-700 text-gray-300 rounded" x-text="keyword"></span>
                  </template>
                </div>
              </template>

              <!-- Focus Reason Badge -->
              <div class="mt-2">
                <span class="text-xs font-medium"
                      :class="{
                        'text-blue-400': obs.phase === 1,
                        'text-purple-400': obs.phase === 2,
                        'text-green-400': obs.phase === 3,
                        'text-orange-400': obs.phase === 4
                      }">
                  <span x-text="getInsightTypeIcon(obs.insight_type)"></span>
                  <span x-text="formatInsightType(obs.insight_type)"></span>
                </span>
              </div>
            </div>
          </template>
        </div>
      </div>

      <!-- Loading State -->
      <div x-show="loading" class="p-12 text-center text-slate-400">
        <svg class="animate-spin h-8 w-8 mx-auto mb-4" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p>Loading observations...</p>
      </div>
    </section>

    <!-- Historical Patterns Section -->
    <section class="rounded-2xl bg-slate-900 shadow" x-show="observations.historical_patterns && observations.historical_patterns.length > 0" x-cloak>
      <div class="p-4 border-b border-slate-800">
        <h2 class="text-xl font-semibold">Historical Patterns</h2>
      </div>
      <div class="p-6 space-y-4">
        <template x-for="pattern in observations.historical_patterns" :key="pattern.type">
          <div class="bg-slate-800 rounded-lg p-4">
            <h3 class="font-semibold mb-2" x-text="pattern.title"></h3>

            <template x-if="pattern.type === 'keyword_frequency'">
              <div class="space-y-1">
                <template x-for="item in pattern.data" :key="item.keyword">
                  <div class="flex items-center justify-between">
                    <span class="text-sm" x-text="item.keyword"></span>
                    <span class="text-sm text-slate-400" x-text="item.count"></span>
                  </div>
                </template>
              </div>
            </template>

            <template x-if="pattern.type === 'insight_types'">
              <div class="space-y-1">
                <template x-for="item in pattern.data.slice(0, 5)" :key="item.type">
                  <div class="flex items-center justify-between">
                    <span class="text-sm" x-text="formatInsightType(item.type)"></span>
                    <span class="text-sm text-slate-400" x-text="item.count"></span>
                  </div>
                </template>
              </div>
            </template>

            <template x-if="pattern.type === 'confidence_trend'">
              <div>
                <p class="text-2xl font-bold text-green-400" x-text="pattern.data.average"></p>
                <p class="text-sm text-slate-400">Based on <span x-text="pattern.data.sample_size"></span> observations</p>
              </div>
            </template>
          </div>
        </template>
      </div>
    </section>
  </div>

  <script>
    function observationsApp() {
      return {
        observations: {
          recent: [],
          by_phase: {1: [], 2: [], 3: [], 4: []},
          historical_patterns: [],
          stats: {}
        },
        activePhase: 'all',
        loading: true,
        sseSource: null,

        init() {
          this.loadObservations();
          this.connectSSE();
        },

        async loadObservations() {
          this.loading = true;
          try {
            const response = await fetch('/api/observations?hours=48&limit=100');
            this.observations = await response.json();
          } catch (error) {
            console.error('Failed to load observations:', error);
          } finally {
            this.loading = false;
          }
        },

        connectSSE() {
          this.sseSource = new EventSource('/events');

          this.sseSource.addEventListener('observation', (e) => {
            const newObs = JSON.parse(e.data);
            this.addNewObservation(newObs);
            this.showToast(`New observation: ${newObs.title}`);
          });

          this.sseSource.onerror = (error) => {
            console.error('SSE error:', error);
          };
        },

        addNewObservation(newObs) {
          // Reload observations to get full data
          this.loadObservations();
        },

        getFilteredObservations() {
          if (this.activePhase === 'all') {
            return this.observations.recent || [];
          }
          return this.observations.by_phase[this.activePhase] || [];
        },

        formatLatestTime() {
          if (!this.observations.stats?.latest_timestamp) return 'N/A';
          const date = new Date(this.observations.stats.latest_timestamp * 1000);
          const now = Date.now();
          const diff = now - date.getTime();

          if (diff < 3600000) {
            const mins = Math.floor(diff / 60000);
            return `${mins}m ago`;
          } else if (diff < 86400000) {
            const hours = Math.floor(diff / 3600000);
            return `${hours}h ago`;
          } else {
            const days = Math.floor(diff / 86400000);
            return `${days}d ago`;
          }
        },

        formatInsightType(type) {
          return type.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        },

        getInsightTypeIcon(type) {
          const icons = {
            'topic_extraction': 'ðŸ“',
            'conversation_theme': 'ðŸ’¬',
            'user_intent_pattern': 'ðŸŽ¯',
            'interaction_quality': 'â­',
            'performance_assessment': 'ðŸ“Š',
            'learning_observation': 'ðŸ“š',
            'improvement_opportunity': 'ðŸ’¡',
            'goal_progress': 'ðŸŽ“',
            'historical_pattern': 'ðŸ“ˆ',
            'relationship_evolution': 'ðŸ¤',
            'adaptive_strategy': 'ðŸ§ ',
            'capability_development': 'ðŸ”§',
            'parameter_adjustment': 'âš™ï¸',
            'behavioral_optimization': 'ðŸŽ›ï¸',
            'predictive_insight': 'ðŸ”®'
          };
          return icons[type] || 'ðŸ”';
        },

        showToast(message) {
          const toast = document.getElementById('toast');
          const toastMessage = document.getElementById('toast-message');
          toastMessage.textContent = message;
          toast.classList.remove('hidden');
          setTimeout(() => {
            toast.classList.add('hidden');
          }, 3000);
        }
      };
    }
  </script>
</body>
</html>
